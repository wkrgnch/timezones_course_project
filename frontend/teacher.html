<!doctype html>
<html lang="ru">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Преподаватель</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body>

<nav class="navbar bg-white border-bottom">
    <div class="container">
        <a class="navbar-brand" href="/frontend/index.html">Главная</a>
        <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/frontend/student.html">Студент</a>
        <a class="btn btn-outline-secondary btn-sm" href="/frontend/teacher.html">Преподаватель</a>
        </div>
    </div>
</nav>

<main class="container my-4">
    <div class="row g-4">
        <div class="col-lg-5">
        <div class="card p-4">
            <h1 class="h5 mb-3">Добавить студента</h1>

            <div class="mb-3">
            <label class="form-label">Имя</label>
            <input id="nameInput" class="form-control" placeholder="Например: Иван" />
            </div>

            <div class="mb-3">
            <label class="form-label">Регион (можно пусто)</label>
            <input id="regionInput" class="form-control" placeholder="Москва, Омская..." />
            </div>

            <div class="d-grid gap-2">
            <button id="addBtn" class="btn btn-accent" type="button">Добавить</button>
            <button id="clearBtn" class="btn btn-outline-secondary" type="button">Очистить</button>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h6 mb-0">Очередь</h2>
            <button id="recalcBtn" class="btn btn-outline-secondary btn-sm" type="button">Пересчитать</button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Студент</th>
                        <th>Регион</th>
                        <th>Местное</th>
                        <th>МСК</th>
                        <th>ΔМСК</th>
                    </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
                </div>

                <p class="text-muted small mb-0">
                очередь 
                </p>
            </div>
        </div>
    </div>
</main>

<script src="/static/js/timezones.js"></script>
<script>
    const KEY = "demo_queue_v1";

    const nameInput = document.getElementById("nameInput");
    const regionInput = document.getElementById("regionInput");
    const tbody = document.getElementById("tbody");

    TZ.attachAutocomplete(regionInput, () => {});

    function loadQueue() {
        try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
        catch { return []; }
    }
    function saveQueue(q) {
        localStorage.setItem(KEY, JSON.stringify(q));
    }

    async function recalc() {
        const q = loadQueue();

        for (const item of q) {
        if (item.region) {
            try {
            const data = await TZ.tzNow(item.region);
            item.local_time = data.local_time;
            item.msk_time = data.msk_time;
            item.msk_offset = data.msk_offset_hours;
            } catch {
            item.local_time = "—";
            item.msk_time = "—";
            item.msk_offset = null;
            }
        } else {
            item.local_time = "—";
            item.msk_time = "—";
            item.msk_offset = null;
        }
        }

        // сортируем по приоритету: больше ΔМСК -> выше приоритет
        q.sort((a, b) => (b.msk_offset ?? -999) - (a.msk_offset ?? -999));

        saveQueue(q);
        render(q);
    }

    function render(q) {
        tbody.innerHTML = "";
        q.forEach((item, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${item.name}</td>
            <td>${item.region || "<span class='text-muted'>общая очередь</span>"}</td>
            <td>${item.local_time || "—"}</td>
            <td>${item.msk_time || "—"}</td>
            <td>${item.msk_offset === null ? "—" : (item.msk_offset >= 0 ? "+" : "") + item.msk_offset}</td>
        `;
        tbody.appendChild(tr);
        });
    }

    document.getElementById("addBtn").addEventListener("click", async () => {
        const name = nameInput.value.trim();
        const region = regionInput.value.trim();

        if (!name) return;

        const q = loadQueue();
        q.push({ name, region });

        saveQueue(q);
        nameInput.value = "";
        regionInput.value = "";

        await recalc();
    });

    document.getElementById("clearBtn").addEventListener("click", async () => {
        saveQueue([]);
        await recalc();
    });

    document.getElementById("recalcBtn").addEventListener("click", recalc);

    recalc();
</script>
</body>
</html>
